---
import HeaderContent from "@/components/category/HeaderContent.astro";
import ContentPromotions from "@/components/content/ContentPromotions.astro";
import H1 from "@/components/elements/headers/H1.astro";
import SearchWrapper from "@/components/search/SearchWrapper.vue";
import ContentLayout from "@/layouts/ContentLayout.astro";
import { getCollection, getEntries, type CollectionEntry } from "astro:content";

export async function getStaticPaths() {
    const category: CollectionEntry<"category">[] =
        await getCollection("category");
    return category.map((business) => ({
        params: { slug: business.slug },
        props: business,
    }));
}

type Props = CollectionEntry<"category">;

const entry: Props = Astro.props;
const {
    name,
    description,
    bannerImage,
    promotedBusinesses,
    relatedCategories,
} = entry.data;

const { Content } = await entry.render();

const promoBusinesses = await getEntries(promotedBusinesses);
const promoCategories = await getEntries(relatedCategories);

const categories = await getCollection(
    "category",
    (category) => !category.data.isVisible
);

const hiddenCategories = categories.map((category) => category.data.name);

const businesses = await getCollection("businesses", ({ data }) =>
    data.categories.some((category) => category.slug === entry.slug)
);

const isGridLayout = businesses.length >= 6;
---

<ContentLayout
    image={bannerImage}
    title={name}
    description={description}
    classList="gap-12 py-12"
    HeaderContent={HeaderContent}
>
    <section class="text-center">
        <Content />
    </section>

    {
        promoBusinesses.length >= 4 && (
            <ContentPromotions businesses={promoBusinesses} classList="" />
        )
    }

    <SearchWrapper
        client:only="vue"
        requiredCategory={name}
        isGridLayout={isGridLayout}
        hiddenCategories={hiddenCategories}
    />

    {
        promoCategories.length > 0 && (
            <section class="text-center">
                <H1 color="coral">Export more Categories</H1>
                <div>
                    <ul>
                        {promoCategories.map((category) => (
                            <li>
                                <a href={`/category/${category.slug}`}>
                                    {category.data.name}
                                </a>
                            </li>
                        ))}
                    </ul>
                </div>
            </section>
        )
    }
</ContentLayout>
